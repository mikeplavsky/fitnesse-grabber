<head>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" 
        href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" 
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" 
        crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>

</head>

<body class="jumbotron">

    <div id="app" class="container">

        <p v-if="error">
            Something went wrong :( Call your captain! 
        </p>
        <p v-else-if="status=='STOPPED'">
            <a v-bind:href="s3_url">S3</a> is ready. 
        </p>
        <p v-else>

            <a v-bind:href="s3_url">S3</a> will be ready in 2-5 min.
            Until it it is not, <a v-bind:href="s3_url">S3</a> will say Access Denied. 

        </p>

        Task: {{taskId}} </br>
        Status: {{status}}

    </div>

</body>

<script>

    const params = new URLSearchParams(window.location.search);
    const taskId = params.get("taskId");

    const app = new Vue({
        el: "#app",
        data: {
            s3_url: "",		
            taskId,
            status,
            error: false
    }});

    let url = "https://4w05r72oja.execute-api.us-east-1.amazonaws.com/test/ecs";

    let getEcsStatus = () => {

        fetch(`${url}?taskId=${taskId}`)
        .then(res => res.json())
        .then(t => {

            app.status = 
                t.tasks.length > 0 ? 
                t.tasks[0].lastStatus : t.failures[0].reason;
            
            app.error = t.failures.length > 0;

            if (t.tasks.length > 0 && app.s3_url == ""){

                const cmd = t.tasks[0].overrides.containerOverrides[0].command;
                const url = new URL(cmd[2]);
                const prefix = cmd[3];

                const s3 = "https://rmad-fitnesse-results.s3.amazonaws.com/";
                app.s3_url = `${s3}${prefix}${url.pathname}.html`;

            }

        });}

    getEcsStatus(); 
    setInterval(getEcsStatus,10000);     

</script>

